<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting token</title>
</head>

<body>
    <script>
        address = "{{ address }}";
        fetch(address + '/getToken', { method: 'POST', body: JSON.stringify({ username: '{{ username }}', password: '{{ password }}' }) })
            .then(response => {
                if (!response.ok) {
                    throw new Error(response.statusText);
                }
                return response.text();
            })
            .then(text => {
                console.log(text);
                fetch('/integrations/api/jellyfin', { method: 'POST', body: JSON.stringify({ address: address, token: text }) })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(response.statusText);
                        }
                        else {
                            response.json().then(data => {
                                if (data.success) {
                                    window.location = '/settings';
                                }else{
                                    window.location = '/integrations/jellyfin/connect';
                                }
                            });
                        }

                    });
            })
            .catch(error => {
                window.location = '/integrations/jellyfin/connect';
            });
    </script>
</body>

</html>